/* ==========================================================
 * slidemapper.js v0.1.0
 * A jQuery plugin to create an animated slideshow tied to a Leaflet map.
 * http://github.com/cavis/slidemapper
 * ==========================================================
 * Copyright (c) 2012 Ryan Cavis
 * Licensed under http://en.wikipedia.org/wiki/MIT_License
 * ========================================================== */
(function(h){var e={slides:[],mapType:"mapquest",apiKey:null,center:[40.423,-98.7372],zoom:4,minZoom:2,maxZoom:10,keyEvents:true,closePopupOnClick:false,mapPosition:"bottom",mapHeight:400,slideHeight:220,autoHeight:false,leafPile:false,animateSpeed:200,controlType:"sides"};var f;var j;function k(o,p){var n=p?-(o.width()):o.width();o.animate({"margin-left":n},f.options.animateSpeed,"swing",function(){o.removeClass("active").removeAttr("style")})}function a(n,o){var p=o?n.width():-(n.width());n.css("margin-left",p).addClass("active");n.animate({"margin-left":0},f.options.animateSpeed,"swing",function(){n.removeAttr("style")});b(n,true)}function i(){var p=j.find(".ctrl-left"),n=j.find(".ctrl-right"),o=j.find(".ctrl-count");(f.index>0)?p.addClass("active"):p.removeClass("active");(f.index<f.items.length-1)?n.addClass("active"):n.removeClass("active");o.html((f.index===null?0:f.index+1)+" of "+f.items.length)}function b(r,o){if(f.options.autoHeight){var s=j.find(".smapp-show");if(!f.autoHeight){f.autoHeight=s.height()}var n=r.find(".slide-inner").height(),q=s.height();if(n>q){o?s.animate({height:n},f.options.animateSpeed):s.height(n)}else{if(n<q){var p=Math.max(n,f.autoHeight);o?s.animate({height:p},f.options.animateSpeed):s.height(p)}}}}function c(n){if(f.index!==null){if(n.keyCode==37){j.slideMapper("prev")}if(n.keyCode==39){j.slideMapper("next")}}}function g(n){if(f.tileLayer){f.map.removeLayer(f.tileLayer);f.tileLayer=false}if(n=="cloudmade"){if(!f.options.apiKey){h.error("apiKey required for cloudmade tiles")}var o={attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>'};f.tileLayer=new L.TileLayer("http://{s}.tile.cloudmade.com/"+f.options.apiKey+"/997/256/{z}/{x}/{y}.png",o)}else{if(n=="stamen-toner"){if(!L.StamenTileLayer){h.error("did you forget to include tile.stamen.js?")}f.tileLayer=new L.StamenTileLayer("toner")}else{if(n=="stamen-terrain"){if(!L.StamenTileLayer){h.error("did you forget to include tile.stamen.js?")}f.tileLayer=new L.StamenTileLayer("terrain")}else{if(n=="stamen-watercolor"){if(!L.StamenTileLayer){h.error("did you forget to include tile.stamen.js?")}f.tileLayer=new L.StamenTileLayer("watercolor")}else{if(n=="mapquest"){var o={subdomains:["otile1","otile2","otile3","otile4"],attribution:'Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png">'};f.tileLayer=new L.TileLayer("http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png",o)}else{if(n=="mapquest-aerial"){var o={subdomains:["oatile1","oatile2","oatile3","oatile4"],attribution:'Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png">'};f.tileLayer=new L.TileLayer("http://{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",o)}else{h.error("invalid tile type: "+n)}}}}}}f.map.addLayer(f.tileLayer)}function l(q){var r,o='style="height:'+q.mapHeight+'px"';if(q.mapPosition==="top"){r='<div class="smapp-map top" '+o+"></div>"}else{if(q.mapPosition==="bottom"){r='<div class="smapp-map bottom" '+o+"></div>"}else{h.error("Invalid mapPosition: "+q.mapPosition)}}var n=q.autoHeight?'<div class="smapp-show" style="min-height:'+q.slideHeight+'px">':'<div class="smapp-show" style="height:'+q.slideHeight+'px">';n+='<div class="smapp-slides-ct"></div>';if(q.controlType==="sides"){n+='<span class="ctrl-left ctrl-side">&lsaquo;</span>';n+='<span class="ctrl-right ctrl-side">&rsaquo;</span>'}else{if(q.controlType==="top"){n+='<div class="ctrl-top">';n+='<span class="ctrl-left">&lsaquo;</span>';n+='<span class="ctrl-count">0 of 0</span>';n+='<span class="ctrl-right">&rsaquo;</span>';n+="</div>"}else{h.error("Invalid controlType: "+q.controlType)}}n+="</div>";var p='<div class="smapp">';p+=(q.mapPosition==="top")?r:"";p+=n;p+=(q.mapPosition==="bottom")?r:"";return p}function m(o,p){f.map.closePopup();if(o.marker&&o.config.popup){if(o.marker._leafpile){o.marker.openPopup()}else{var n=o.marker._popup.setLatLng(o.marker.getLatLng());f.map.openPopup(n)}}f.map.setView(o.center,o.zoom||f.map.getZoom(),p?false:true)}var d={init:function(n){if(!f){f={};f.options=h.extend({},e,n);d.options(n||{})}},options:function(o){if(o===undefined){return f.options}else{f.options=h.extend({},f.options,o);j.empty();j.append(l(f.options));showEl=h(".smapp-show",j)[0];mapEl=h(".smapp-map",j)[0];h(showEl).on("click",".ctrl-left",function(){j.slideMapper("prev")}).on("click",".ctrl-right",function(){j.slideMapper("next")});d.keyEvents(f.options.keyEvents);f.options.center=new L.LatLng(f.options.center[0],f.options.center[1]);f.map=new L.Map(mapEl,f.options);g(f.options.mapType);if(f.options.leafPile){if(!L.Leafpile){h.error("Did you forget to include leafpile.js?")}var n=f.options.leafPile===true?{}:f.options.leafPile;f.markergroup=new L.Leafpile(n);f.markergroup.on("leafpileclick",function(r){var p=r.markers[0].index;if(f.frozen){r.cancelZoom()}if(j.triggerHandler("move",[d.get(p),p])===false){return}f.map.closePopup();if(f.index!==null){k(f.items[f.index].$slide,(p>f.index))}a(f.items[p].$slide,(p>f.index));if(f.items[p].config.popup){var q=r.markers[0]._popup.setLatLng(r.markers[0].getLatLng());f.map.openPopup(q)}f.index=p;i()})}else{f.markergroup=new L.LayerGroup()}f.map.addLayer(f.markergroup);f.items=[];f.index=null;d.add(f.options.slides)}},keyEvents:function(n){h(document).unbind("keydown",c);if(n){h(document).keydown(c)}},mapEvents:function(r){var q=["dragging","touchZoom","doubleClickZoom","scrollWheelZoom","boxZoom"];var o=r?"enable":"disable";for(var n=0;n<q.length;n++){var s=q[n];if(f.map[s]&&typeof(f.map[s][o])==="function"){f.map[s][o]()}}},freeze:function(n){f.frozen=n;n?d.keyEvents(false):d.keyEvents(true)},count:function(){return f.items.length},get:function(n){n=(n===undefined||n===null)?f.index:n;return(f.items[n]===undefined)?false:f.items[n]},add:function(o){var n=(f.items&&f.items.length)?f.items.length:0;return d.insert(n,o)},insert:function(p,n){if(h.isArray(n)){var o=[];h.each(n,function(u,v){o.push(d.insert.call(this,p+u,v))});return o}if(!h.isNumeric(p)||p<0||p>f.items.length){h.error('Invalid index "'+p+'" provided to insert')}var s={index:p,config:n};if(n.marker){var t=new L.LatLng(n.marker[0],n.marker[1]);s.marker=new L.Marker(t);if(n.popup){s.marker.bindPopup(n.popup)}s.marker.index=p;s.marker.on("click",function(v){var u=v.target.index;if(!f.frozen&&j.triggerHandler("move",[d.get(u),u])!==false){if(f.index!==null){k(f.items[f.index].$slide,(u>f.index))}a(f.items[u].$slide,(u>f.index));f.index=u;i()}});f.markergroup.addLayer(s.marker)}var r='<div class="slide"><div class="slide-inner">'+(n.html||"")+"</div></div>";if(p==f.items.length){s.$slide=h(r).appendTo(j.find(".smapp-slides-ct"))}else{s.$slide=h(r).insertBefore(f.items[p].$slide)}s.zoom=s.marker?n.zoom:f.options.zoom;s.center=s.marker?s.marker.getLatLng():f.options.center;if(n.center){s.center=new L.LatLng(n.center[0],n.center[1])}f.items.splice(p,0,s);for(var q=p+1;q<f.items.length;q++){f.items[q].index++;if(f.items[q].marker){f.items[q].marker.index++}}if(f.items.length==1){d.move(0,false)}else{if(f.index===p){f.index++}}i();return s},shuffle:function(s,r){var n=(r===undefined||r===null)?f.index:s;var q=d.get(n);if(!q){h.error('Invalid from index "'+n+'" provided to remove')}var p=(r===undefined||r===null)?s:r;if(p=="first"){p=0}if(p=="last"){p=f.items.length-1}if(!h.isNumeric(p)||p<0||p>f.items.length-1){h.error('Invalid to index "'+p+'" provided to insert')}if(n==p){return}f.items.splice(n,1);for(var o=n;o<f.items.length;o++){f.items[o].index--;if(f.items[o].marker){f.items[o].marker.index--}}if(p==f.items.length){q.$slide.appendTo(j.find(".smapp-slides-ct"))}else{q.$slide.insertBefore(f.items[p].$slide)}q.index=p;if(q.marker){q.marker.index=p}f.items.splice(p,0,q);for(var o=p+1;o<f.items.length;o++){f.items[o].index++;if(f.items[o].marker){f.items[o].marker.index++}}if(f.index==n){f.index=p}i();return q},remove:function(n){var q=d.get(n);if(!q){h.error('Invalid index "'+n+'" provided to remove')}if(f.items.length==1){return d.removeAll()}if(q.marker){f.markergroup.removeLayer(q.marker)}q.$slide.remove();f.items.splice(q.index,1);for(var o=q.index;o<f.items.length;o++){f.items[o].index--;if(f.items[o].marker){f.items[o].marker.index--}}if(f.index===q.index){var p=Math.min(q.index,f.items.length-1);a(f.items[p].$slide,(p>=f.index));m(f.items[p],true);f.index=p}i()},removeAll:function(){f.map.removeLayer(f.markergroup);j.find(".smapp-slides-ct").empty();f.markergroup=new L.LayerGroup();f.map.addLayer(f.markergroup);f.items=[];f.index=null;i();f.map.setView(f.options.center,f.options.zoom)},move:function(o,n){if(f.frozen){return}if(!d.get(o)){return}if(j.triggerHandler("move",[d.get(o),o])===false){return}if(n){if(f.index!==null){k(f.items[f.index].$slide,(o>f.index))}a(f.items[o].$slide,(o>f.index))}else{if(f.index!==null){f.items[f.index].$slide.removeClass("active")}f.items[o].$slide.addClass("active");b(f.items[0].$slide,false)}m(f.items[o],n);f.index=o;i()},next:function(){d.move(f.index===null?0:f.index+1,true)},prev:function(){d.move(f.index===null?0:f.index-1,true)}};h.fn.slideMapper=function(p){if(this.length>1){h.error("SlideMapper currently only supports 1 map per page")}else{if(p&&typeof p!=="object"&&!d[p]){h.error("Method "+p+" does not exist on jQuery.slideMapper")}else{var n=null;for(var o=0;o<this.length;o++){j=h(this[o]);f=j.data("slideMapper");if(d[p]){if(!f){h.error("Method "+p+" called on uninitialized element")}else{n=d[p].apply(this[o],Array.prototype.slice.call(arguments,1))}}else{d.init.apply(this[o],arguments)}j.data("slideMapper",f)}return(n===null?this:n)}}}})(jQuery);
